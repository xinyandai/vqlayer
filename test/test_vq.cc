//
// Created by xinyan on 10/3/2020.
//
#include <iostream>

#include "test.h"
#include "../include/vq.h"


using std::vector;

void test_l2dist() {
  vector<T>  a_  = { 0.1357047994833403, -0.9500842332443221,
                     0.12282730752559588, 1.901416969226425,
                     -1.573997496240008, 0.20564681374665741,
                     -1.2207054473768937, 1.5676540439571955 };
  vector<T>  b_  = { 1.7100876807416627, -0.0916384140982638,
                     -0.521708942952666, -0.2554553782549226,
                     -0.7275724232438326, 0.9838586571305012,
                     -0.9566618187976683, 0.31541295429937083 };
  float norm =  11.243011844519039 ;
  compare("l2dist", l2dist_sqr(a_.data(), b_.data(), a_.size()), norm);
}

void test_normalize() {
  vector<T>  x_  = { -0.7013111947006322, 2.0916561690332434,
                     -1.9366954724327659, -0.3323386267204376,
                     -0.2401314937676975, -1.551648923978096,
                     -1.1261494917863988, 0.25266865981609093 };
  vector<T>  n_  = { -0.19815927256176744, 0.5910087676297393,
                     -0.5472237843782981, -0.09390407712400847,
                     -0.06785045281430274, -0.4384267987879468,
                     -0.3181996320242052, 0.07139289691459437 };

  normalize(x_.data(), x_.size());
  compare("normalize", x_, n_.data(), x_.size());
}

void test_kmeans() {
  const size_type n = 32;
  const size_type ks = 16;
  const size_type d = 8;
  const size_type iter = 1;
  vector<T> centroids(ks * d);
  vector<CodeType>  codes(n);

  vector<T>  data_  = { 0.5013439550843258, 0.8194090925680525, 0.6781777353062023, 1.0691496492432506, -1.0319710859254412, 1.2359116899529472, 0.274737619263903, 0.1744930023873987, 1.4374497979290872, -0.6243117882769137, 0.7499795905289495, -0.6385011100486866, 1.1122298241467696, -1.1265160106884633, 0.8191511110376674, -1.1742027131592543, -0.4850513452345629, -0.9422070142142563, 0.9135602954127136, -1.0062538359338382, -0.21222373194416486, -2.125477352354407, 0.7173880809770504, 1.0024076122944632, 0.6193188042409286, 0.6971079435550949, -1.2587690769953743, -1.4546516789244803, 0.4261777194982905, 0.5438852670972883, 1.4316724848560782, 1.224708557489934, 0.1365424118343076, -0.6076167197981884, 0.9996932058149126, 0.35418028488315006, 0.3953133853822097, 0.338548541451247, -1.4396762195018393, -0.48264662053174534, -1.123192886648453, 0.19435460097699805, 0.3338132447838781, -1.9625252811713494, -0.8560241842795873, -0.258156638374668, -0.2566416137253764, 0.5233837912963571, -0.049972540530034006, -0.2995893327781544, -0.4096507366451091, 1.3549091255935584, 0.8303495476334842, -1.2461428715722243, 1.3455446375954299, 0.08887151823558256, 1.352094563050969, -1.1267108563122321, -1.8115001037454788, 0.23145934851278668, -0.9402517909137028, 2.3360503480540498, 2.44960138177939, 0.2801282159784517, -0.38302193928352873, -0.17216557116146483, -0.6707190426732398, -0.8918148930760618, 1.0865542088957025, -0.2569608256492389, -0.2950985709897265, -0.3664992938523214, 0.6581569418360234, 0.5739332317217537, 0.22117526581414584, -1.2253350222519899, -2.4616875871584454, 0.20539846534434292, 0.5974108290995996, -0.5481507592904135, 0.5479440432403342, -1.0197106038997563, -0.3616607918608846, -0.6896197193300379, 0.620890467496725, -0.35606091704431597, -0.1714913138142154, -0.6923660225563382, 0.6175952152061575, -1.2068086846094415, -0.24502815350123908, 1.1581158805319036, 0.5945109703480248, 0.38163851020898065, -0.6474679574168459, -0.8681774930646813, -0.10795054828807477, -1.3306948233123375, 1.488309311904456, 0.3329561038621411, 0.05032850519395302, 1.441518131552092, 1.618954480404948, 2.1292405194615327, -1.6918537378134662, -1.2349991865368521, 1.0216804722625905, -0.6467304789211571, -0.19182314413182824, 0.7824038897188528, -1.6259647562371555, -0.7609930704470865, -3.201779315227147, -1.6475213031879337, -0.8855770958724045, 0.05700582137249548, -0.5480545134946717, -2.5480862566098756, 0.37363943615893896, 0.23044741975403152, -0.8584706678812667, 0.19050162778273894, -0.8528333151327427, 0.3619208337742995, 0.3268942756270823, -0.5265954441741146, 0.768392677438234, 0.20102412666686828, 1.422560312739701, -1.1904737358603872, 0.679425432966858, 0.45434540812972446, 0.07774207330962882, -0.20778685733102067, 0.4969348976762749, -0.081635982017849, -0.703959657866808, 1.0481262859989164, -0.3013280721177806, -0.21215058045276297, 1.2619861376963837, -0.6088621759342412, 0.037162715546063596, 2.910787148389879, 0.15558810557347266, 0.3366089310282033, -1.3513873110381327, 0.07777883335547116, 1.2674422354184913, 0.8811495827938945, -0.2879260502777915, 0.8810834701616007, -0.05318916665436661, 1.8361485268034694, 0.046291376304470055, 0.10789389081138104, 0.7926234200498997, -0.4250582779269937, 1.6155355995313083, -0.07412214512779919, -0.7251292704974726, 1.3766561265909518, -0.8173042985115239, -0.8499918430242911, -1.0056223689112864, 0.8768793192532174, -2.8311790720738883, 0.3477219932681963, -0.14417774308775216, -1.0896583135246234, 0.13916532899445658, 0.5438931909340962, 0.40518973801607744, -0.6172662147171426, 0.3375205926931273, -0.48654745252259307, 0.02072233001154158, -1.3450029019837884, -0.06702821122124326, -0.9628234910095276, -1.1791937251013338, 0.8753356047458913, 0.6288948638090683, 0.357108515603561, -1.6778084013609924, -0.8496849816002798, -1.8240808381654205, -0.9738754598025906, 0.6082189806809922, 1.228966655371302, -0.2756093914763788, 0.20877565848231, 0.42599822567084356, -0.013254283114691465, -0.9956902302752703, -0.40371975744849525, -1.256374949097508, -0.4041476937352864, 0.4519993937134064, 0.15374017556204617, 0.46465387437879296, 0.7727365314672417, 0.503016237357412, -0.6144499297437448, 0.28440419240839754, -0.7441200681938499, -1.3438091057943606, -1.6492375321725363, -0.2483485235226663, 0.9147990622114628, -0.5914665073487031, -0.23037599354895044, -0.14050452197417226, 0.27469494646779413, 0.6227505335694915, -2.055077850330623, -0.549506846534568, -0.7826089546319459, -1.4286084379084378, -1.2939315027037102, -1.2313722107676075, -1.5803405205310175, -0.8574083771941362, 0.39646964425767617, 0.037234748392180425, 0.4746548160620724, -0.6661298333763839, 0.7118493296735392, -0.9489777201343885, 0.555393832567208, 0.15141167415284434, -0.9587242783001809, -2.127727905747661, 1.0350349849585216, 0.6987364520849352, 2.035944947143235, 0.041878464828708446, -0.8417423931366091, -0.2735653642923115, 0.7794583872331011, -0.7897338202978453, -0.3297659923863792, 0.9425853218361839, -0.13486264897483116, 1.0353317590263795, -0.08216805539843766, -0.6253149536553158, 0.5313106951266588, -0.3987240394509479, 0.6432537799690246, -0.4747420204164268, 0.5397833313439818, 0.026057902417047484, -1.2476842502917, -1.6107733420101291, 0.3085355760860316 };
  vector<CodeType>  codes_  = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 10, 15, 8, 15, 5, 10, 5, 8, 9, 4, 8, 5, 0, 15, 4, 15 };
  vector<T>  centroids_  = { 0.26928935173825314, 0.6470319543150624, 0.006023950964909208, 0.8904994894583949, -0.9904744030299149, 0.8956527612600775, 0.21307464670837367, -0.3921156379563911, 1.4374497979290872, -0.6243117882769137, 0.7499795905289495, -0.6385011100486866, 1.1122298241467696, -1.1265160106884633, 0.8191511110376674, -1.1742027131592543, -0.4850513452345629, -0.9422070142142563, 0.9135602954127136, -1.0062538359338382, -0.21222373194416486, -2.125477352354407, 0.7173880809770504, 1.0024076122944632, 0.6193188042409286, 0.6971079435550949, -1.2587690769953743, -1.4546516789244803, 0.4261777194982905, 0.5438852670972883, 1.4316724848560782, 1.224708557489934, -0.0628458446949149, -0.05488206023910863, 0.8150982550028362, -0.13171076461180864, 0.5716831122723289, -0.16257986071368016, -1.1362667596505052, -0.5335244858592075, -0.594276668417238, -0.1391502822619461, -0.4947819257143317, -1.2673180294772195, -1.0680531222649536, -0.021570558726644207, -0.8290835497960832, 0.40617098610644764, -0.049972540530034006, -0.2995893327781544, -0.4096507366451091, 1.3549091255935584, 0.8303495476334842, -1.2461428715722243, 1.3455446375954299, 0.08887151823558256, 1.352094563050969, -1.1267108563122321, -1.8115001037454788, 0.23145934851278668, -0.9402517909137028, 2.3360503480540498, 2.44960138177939, 0.2801282159784517, -0.5383976896484287, 0.05738936011948034, -1.109413424806374, -0.5045718782680328, 0.7054277257552535, 0.5319625897459379, -0.05897086979360136, -0.33292950388475845, 0.5420775837534335, 0.2803394743035311, -0.3872574822305622, -0.8145273898502425, -1.8590312681279766, -0.09937461419547175, 0.524705111406503, -0.19720529186418365, 0.608775537630761, -1.0999475510949221, 0.15230999003347664, 0.10287295991126093, 0.3679407596074771, -0.39370466303082646, 0.22098805885172892, -0.4201831523655934, 0.6175952152061575, -1.2068086846094415, -0.24502815350123908, 1.1581158805319036, 0.5945109703480248, 0.38163851020898065, -0.6474679574168459, -0.8681774930646813, -0.10795054828807477, -1.3306948233123375, 1.488309311904456, 0.3329561038621411, 0.05032850519395302, 1.441518131552092, 1.618954480404948, 2.1292405194615327, -1.6918537378134662, -1.2349991865368521, 1.0216804722625905, -0.6467304789211571, -0.19182314413182824, 0.7824038897188528, -1.6259647562371555, -0.7609930704470865, -3.201779315227147, -1.6475213031879337, -0.8855770958724045, 0.05700582137249548, -0.5480545134946717, -2.5480862566098756, 0.37363943615893896, 0.23044741975403152, -0.8284142875202101, 0.9506130411025342, -0.176775115855509, 0.5666784845240269, 0.48988804012382436, -0.7299885082927318, 0.1073504572426331, 0.8251366186496162 };

  kmeans(centroids.data(), codes.data(), data_.data(), n, ks, d, iter);
  compare("code", codes.data(), codes_.data(), codes_.size());
  compare("dict", centroids.data(), centroids_.data(), centroids.size());
}


int main() {
  test_l2dist();
  test_normalize();
  test_kmeans();
  return 0;
}
